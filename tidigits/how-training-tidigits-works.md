---
layout: default
title: How To Train TIDIGITS
---

#Introduction
TIDigits is a comparatively simple connected digits recognition task.
Like many well-known corpia, Kaldi includes a example script for it.
It is fairly typical for the example scripts.

The example script can be foung in `kaldi-trunk/egs/tidigits/s5/` all other scripts refered to here are relitive to that path. Kaldi example scripts are all written to be run from that path (or it equivelent in other examples) even if they are located in a subfolder.
Kaldi example scripts should only be run in `bash`

The offical [Kaldi tuitorial](http://kaldi.sourceforge.net/tutorial.html) is a bit all over the place, but worth a look, it is no doubt getting better as the software matures.

##The Three Major Steps

There are Three Steps to applying Kaldi to a task such as this.

<ol>
<li> Data Preparation:
<ul>
   <li> Locating the datafiles</li>
   <li> Parsing its annotations (eg Speaker Labels, Utterance Labels)</li>
   <li> Converting the audio data format</li>
</ul></li>
<li> Language Preparation:
<ul>
   <li> Creating a Language Model in OpenFST</li>
</ul></li>
<li>Training/Evaluating the Speach Recogniser:
<ul>
<li> This is the only step that is actually done in Kali proper, rather than by helper scripts and tools.</li>
<li> Viewing the results is also nontrivial</li>
<li> Kaldi does not store results in the most clear way,</li>
</ul></li
</ol>

The full process can be carried out by running `bash run.sh`. Though you most likly need to edit at least the TIDIGITs path, and the `cmd.sh` (so that it is set to run locally, not on a cluster).


#Data Preparation
[The offical kaldi documentation on this section](http://kaldi.sourceforge.net/data_prep.html#data_prep_data). It is the basis of alot of this section.

These steps are carried out by the script `local/tidigits_data_prep.sh`. It takes one parameter -- the path to the dataset.

One should realise after looking at this section (and the next), just how valuable AWK and Bash (or equivelents) are for this task.


##Locate the Dataset 
on on the SIP network, the TIDIGITs data set can be found at `/user/data14/res/speech_data/tidigits/`. Symlink it into a convient location.

##Parse its anonotations
Files such as `wav.scp` need to be generated for 

###Kaldi Script: `.scp`: Basically just a list of Utterances to Filenames
A Kaldi script file is just a mapping from record_id, to extended-filenames.

Line Format:

```
<recording_id> <extended_filename>
```

####Recording ID
The recording ID is the first part of each line in a  `.scp` file.
If speaker id is available (which is is for tidigits), it should form the first part of the recording id.
Kaldi requires this not for speaker identification, but for purposes of sorting for training (`utt2spk` is for that).

The remained of the speaker ID is arbairy, so long as it is unique.
For convience of generating the unique id, the example script for TIDIGITS uses
`<speaker-id>_<transcription><sessionid>`.

As there is only one Utterance per recording in TIDIGITS, the Recording ID is the Utterannce ID.
(See below)


####Extended Filename
The second part of the line is the extended filename
Extended Filename is the term used by Kaldi,  to refer ot a string that is either the path to a wav-format file or it is a bash command that will output wav-format data to standard out, followed by a pipe symbol (`|`).

As the TIDIGITS data is in the [SPHERE audio format](http://www.ee.columbia.edu/ln/LabROSA/doc/HTKBook21/node64.html), it needs to be converted to wav.
So the sample scripts in Kaldi use `sph2pipe` to convert them, so the .scp files lines will look like: (assuming `sph2pipe` is on your PATH, otherwise Path to the executable will need to be used)

```
ad_16a sph2pipe -f wav ../tidigits/test/girl/ad/16a.wav |
```

###Segmentation File `segments`
If there were multiple utterances per recording then there would need to be a segementation file as well,
mapping RecordingIDs and Start-End times to Utterance IDs.
(See [The offical kaldi documentation on this section](http://kaldi.sourceforge.net/data_prep.html#data_prep_data)).
As there is not, by not creating a `segments` file, Kaldi defaults to utterance id == recording id.


###Text Transcription file `text`
The text transcription must be stored in a file, which the example calls `text`.
each line is an utterance-id followed by a transcription of what is said. 
Eg:

```
ad_1oa 1 o
ad_1z1za 1 z 1 z
ad_1z6a 1 z 6
ad_23461a 2 3 4 6 1
```

Notice the Utterance-ID format as descibed above.
Notice also, for later, that the transcription here is in word space, not phoneme space.

###Utterance to Speaker Mappings `utt2spk`
This file maps each utterance id to a speaker id.
Each line has the form `<utterance id> <speaker-id>`.

`spk2utt` is the opposite, and can be generated by using the script `utils/utt2spk_to_spk2utt.pl`.
Each like starts with a speaker id, then has every utterance id they spoke.

#Language Preparation
[The offical kaldi documentation on this section](http://kaldi.sourceforge.net/data_prep.html#data_prep_lang).

To understand this section you should first [understand openFST]( ../fst-example/intro_to_OpenFST.md).

##The Phones
Kaldi expects a number of files to be in the `data/lang/phones/` directory.
Most of them are not complex for TIDIGITS.

To falcilitate the creation of this, it is useful to have a full list of phonemes. This could be created many ways. One way it to apply Awk to the lexicon (see next section).

These phone files a simple lists with one phone each line:

 - `silence.txt`, `context_indep.txt` and `optional_silence.txt` all are made to just single like files containing `sil` the silence phoneme symbol.
 - `nonsilence.txt` contains all other phonemes.

The following files would do alot more in more complicated situations, but are ssimple for TIDIGITS
- `sets.txt` each line contains a set of phones that should be considered to be the same phoneme (ie a set of morphemes for one phoneme). Since in TIDIGITS this is not a concern (we don't have access to a morpheme level transcription), each set contains just the one phonene so all phonems should be listed on there own line in this file. Including sil.
- `disambig.txt` should be created and left empty.
- `extra-questions.txt` should also be created and left empty.

###Generating isymbols files from the phones.
Once you have a phonelist, it is very easy to enumerate it to create the isymbols file required for the phoneme-word FST.

###Convertering Symbol Phonelist to Integer Phone Lists 
Once you have aisymbols file, each of the files created in the previous set need to be converted to lists of there matching integers rather than textual symbols. The files created this way have the same name, but with a `.int` extension.

The perl script `utils/sym2int.pl` is used for this. It can take a single paramerter of the symbols file, and then will take on standard in, the sybolic (`.txt`) phone lists, and output (on standard out), there corrisponding integer forms.


silence, nonsilence, context_indep, optional_silence, disambig
 all also need to be converter to colon seperated list files (`.csl`),
 these are the same as the `.int` files, but instead of the integer phone representation being seperated by linebreaks, they are seperated with colons. A simplish job for Awk/sed.

###roots.txt Decision Tree Roots
Kaldi makes use of Decision Trees for some functionality.
See [the documentation](http://kaldi.sourceforge.net/tree_externals.html) for the why and how of this.

It require a root definition file.
For TIDIGITS is is very simple.
`roots.txt` contains  on each line, `shared split <phone-symmbol>`, and has one line for each phone.
It is converted to `roots.int`, by converting each phone symbol to it integer representation.

##Words and Out of Vocabulary Lists
A word symbol list will also need to be constructed for the FST.
Again this can be generated from the lexicon (see below), with Awk.

The word symbols are simply: o, z ,1, 2, 3, 4, 6, 7, 8, 9.

To go with this Kaldi needs to be told what word to use when words that are not in the vocabulary list are found. Since no such words exist in TIDIGITS, it really doesn't mater what it done with them. But Kalidi requires the files.

Create a oov.txt with any one word in it. (Example script uses z).
Create a oov.int with the matching interger for it.
This can be done manually,
or it could be done with `sym2int` on the words symbol list, created earlier.
<sub>
If you arranged you wordsymbols so that the int form of your oov word is the same is its text form then you are either over or under thinging this, and  you could copy the oov.txt to oov.int</sub>

## The Lexicon
The example recipy for TIDIGITs is quiet clever about contructing the phoneneme to word FST.
There script `util/make_lexicon_fst.pl` takes a lexicon file, and outputs a text FST file.
Each line of the Lexicon file has the format:

```
<word> <phoneme> <phoneme> <phonen....
```

ie one word followed by its phonene make up, specified with space delimited symbols.


### Converting Lexicon to lexicon.fst.txt: `util/make_lexicon_fst.pl`
The Full break-down of how to use it (which will be output if no arguements are passed to it):

Usage: 
```
make_lexicon_fst.pl [--pron-probs] lexicon.txt [silprob silphone [sil_disambig_sym]] >lexicon.fst.txt
```

Creates a lexicon FST that transduces phones to words, and may allow optional silence.
Note: ordinarily, each line of `lexicon.txt` is: `w`fstcompile`ord phone1 phone2 ... phoneN`; if the `--pron-probs` option is used, each line is: `word pronunciation-probability phone1 phone2 ... phoneN`.  The probability 'prob' will typically be between zero and one, and note that it's generally helpful to normalize so the largest one for each word is 1.0, but this is your responsibility.  The silence disambiguation symbol,
e.g. something like #5, is used only when creating a lexicon with disambiguation symbols, e.g. L_disambig.fst, and was introduced to fix a particular case of non-determinism of decoding graphs.

###Compiling the Lexicon FST:  `L.fst`
The lexicon.fst.txt, is then compiled (`fstcompile`), using isymbols and osymbols from the generated from the lexicon.txt, plus the silence phoneme (silphone) added in the make lexicon.txt.fst step, plus a emptysi
It it then arcsorted with `fstarcsort` on output lable. (not sure why this is required.)

####L_disambig.fst = L.fst

To quote the tidigits recipe:
>in this setup there are no "disambiguation symbols" because the lexicon
 contains no homophones; and there is no '#0' symbol in the LM because it's
 not a backoff LM, so L_disambig.fst is the same as L.fst

SO L.fst is copied to L_disambig.fst

For more information on disambiguation read the [documentation page](http://kaldi.sourceforge.net/graph.html#graph_disambig).




#Training/Evaluating Recogniser

